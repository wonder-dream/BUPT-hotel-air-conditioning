# 波普特酒店空调系统 - 功能测试指南

本指南将指导你如何完整测试系统的各项功能，包括入住、空调控制、调度监控和结账报表。

## 系统特性

- **时间压缩**：系统时间 = 真实时间 × 6（TIME_SCALE=6）
- **房间配置**：301-305 共 5 个房间
- **同时服务上限**：3 个房间
- **时间片**：120 秒（系统时间），即真实时间约 20 秒

## 房间价格

| 房间号 | 每日房价 | 房费计算规则 |
|--------|----------|--------------|
| 301 | 100 元 | 按空调开机次数计算 |
| 302 | 125 元 | 每次开机算一天 |
| 303 | 150 元 | 自动重启不计入 |
| 304 | 200 元 | 至少收取1天 |
| 305 | 100 元 | |

## 温控范围

| 模式 | 温度范围 |
|------|----------|
| 制冷 | 18°C - 28°C |
| 制热 | 18°C - 25°C |

---

## 1. 启动系统

请确保你已经运行了以下两个脚本（保持窗口打开）：
1. 双击运行 `start_backend.bat` (启动后端 API)
2. 双击运行 `start_frontend.bat` (启动前端界面)

打开浏览器访问前端地址（通常是 http://localhost:5173）。

---

## 2. 角色扮演测试流程

建议开启两个浏览器窗口：
- **窗口 A**：模拟前台和管理员（用于办理入住、监控、结账）
- **窗口 B**：模拟住客（用于控制空调）

### 第一步：前台办理入住
**操作角色**：前台 (窗口 A)
**页面**：点击导航栏或访问 `/reception`

1. 点击左侧 **"入住办理"**。
2. 填写测试信息：
   - 姓名：`测试员1`
   - 手机：`13800000001`
   - 身份证：`110101199001010001`
   - 房间号：选择 `301`
3. 点击 **"确认"**。
   - ✅ **预期结果**：提示"入住成功"，显示房间和订单信息。
4. 重复上述步骤，为 `302`, `303`, `304` 房间也办理入住（为了测试调度队列）。
**注意：每个测试员信息需均不相同**

### 第二步：客户开启空调
**操作角色**：住客 (窗口 B)
**页面**：访问 `/room/301`（每个房间有独立页面）

1. 直接访问对应房间的页面（如 `/room/301`）。
2. 查看当前状态，应为"已关闭"。
3. 点击 **"开启"** 按钮。
   - ✅ **预期结果**：状态变为"已开启"，模式显示"制冷"（默认）。
4. 调节设置：
   - 温度：拖动滑块或点击加减号，设为 **22°C**。
   - 风速：点击 **"高"**。
5. 观察费用：
   - ✅ **预期结果**：等待几秒后，"累计使用费用"开始上涨（高风速涨得快）。
   - ✅ **预期结果**：当前温度（状态栏显示）应该开始缓慢下降。

### 第三步：多房间调度测试 (核心功能)
**操作角色**：住客 (窗口 B) & 管理员 (窗口 A)

1. **窗口 B (住客)**：
   - 打开新标签页访问 `/room/302` -> 开机 -> 风速设为 **"中"**。
   - 打开新标签页访问 `/room/303` -> 开机 -> 风速设为 **"低"**。
   - 此时已有 3 个房间（301, 302, 303）在运行，达到服务上限。

2. **窗口 B (住客)**：
   - 打开新标签页访问 `/room/304` -> 开机 -> 风速设为 **"高"**。

3. **窗口 A (管理员)**：
   - 进入 **"空调监控"** 页面 (`/monitor`)。
   - ✅ **预期结果**：
     - **服务队列**：应该包含 301(高), 304(高), 302(中)。
     - **等待队列**：应该包含 303(低)。
     - **原因**：304(高风) 优先级高于 303(低风)，发生了**抢占调度**。303 被挤入等待队列。

### 第四步：温控与自动待机
**操作角色**：管理员 (窗口 A) 或 住客 (窗口 B)

1. 观察正在运行的房间（例如 301）。
2. 当 **当前温度** 降至 **目标温度** (22°C) 时：
   - ✅ **预期结果**：状态变为 **"待机"** (Standby) 或监控页面的状态灯变色。
   - ✅ **预期结果**：服务资源释放，等待队列中的房间（如 303）应该自动补位进入服务队列。
3. 等待一段时间（模拟回温）：
   - 当温度回升超过 1°C（例如变回 23°C）时。
   - ✅ **预期结果**：空调自动重新启动，再次申请服务。
   - ✅ **预期结果**：**自动重启不增加开机次数**，不影响房费天数计算。

### 第五步：结账与报表
**操作角色**：前台 (窗口 A)

1. 进入 **"前台服务"** (`/reception`)。
2. 点击左侧 **"结账办理"**。
3. 输入房间号 `301`，点击 **"确认"**。
   - ✅ **预期结果**：显示详单，包括房费和空调费。
   - ✅ **房费计算**：房间价格 × 空调开机次数（至少1天）。
   - 例如：301房间开机1次 → 房费 = 100元 × 1 = 100元。
4. 点击 **"立即支付"**。
   - ✅ **预期结果**：提示支付成功，房间状态重置为空闲。

### 第六步：查看报表
**操作角色**：经理 (窗口 A)

1. 进入 **"统计报表"** (`/report`)。
2. 选择今天日期，点击 **"查询"**。
   - ✅ **预期结果**：
     - 统计卡片显示总收入、空调收入等。
     - 下方列表中出现刚才 301 的订单记录，状态为"已退房"。

---

## 3. 常见问题排查

- **Q: 费用不增加？**
  - A: 检查后端窗口是否有报错。确保房间处于"运行中"状态（非待机、非等待）。
- **Q: 调度没反应？**
  - A: 调度器每秒运行一次，可能有 1-2 秒延迟。确保已开启至少 4 个房间才能看到排队效果。
- **Q: 乱码？**
  - A: 确保使用了提供的 `start_backend.bat` 启动，它会自动修复编码问题。
- **Q: 房费计算不正确？**
  - A: 房费按空调开机次数计算。检查订单的 `power_on_count` 字段。自动重启（从待机恢复）不计入开机次数。
- **Q: 服务时长显示异常？**
  - A: 前端显示的是**系统时间**（真实时间 × 6），例如真实运行 10 秒，显示 60 秒/1 分钟。

---

## 4. 自动化测试脚本

项目提供了自动化测试脚本，位于 `tests/` 目录：

### 测试脚本列表

| 脚本 | 功能 | 运行方式 |
|------|------|----------|
| `test_heating.py` | 制热模式自动化测试 | `python tests/test_heating.py` |
| `test_cooling.py` | 制冷模式自动化测试 | `python tests/test_cooling.py` |
| `test_scheduler.py` | 调度器单元测试 | `python tests/test_scheduler.py` |
| `generate_room_report.py` | 生成房间测试报告 | `python tests/generate_room_report.py` |
| `check_db.py` | 数据库检查工具 | `python tests/check_db.py` |

### 运行自动化测试

```bash
# 进入项目根目录
cd BUPT-hotel-air-conditioning

# 确保后端服务已启动
# 然后运行测试脚本

# 制热模式测试
python tests/test_heating.py

# 制冷模式测试
python tests/test_cooling.py
```

### 测试数据

测试数据位于 `tests/data/` 目录，包含 Excel 格式的测试用例：
- `test_hot.xlsx` - 制热模式测试数据
- `test_cold.xlsx` - 制冷模式测试数据

测试脚本会自动读取这些数据，模拟多房间并发操作，并生成测试报告。

---

## 5. 房费计算验证

### 验证步骤

1. 办理入住（如 301 房间）
2. 开启空调 → **开机次数 +1**
3. 达到目标温度后待机
4. 温度回升自动重启 → **开机次数不变**
5. 手动关机
6. 再次手动开机 → **开机次数 +1**
7. 结账时验证房费 = 房间价格 × 开机次数

### 验证示例

| 操作 | 开机次数 | 房费（301房间=100元/天） |
|------|----------|--------------------------|
| 入住时 | 0 | - |
| 第一次开机 | 1 | 100元 |
| 待机后自动重启 | 1 | 100元（不变） |
| 手动关机后再开机 | 2 | 200元 |
| 再次手动开关机 | 3 | 300元 |
